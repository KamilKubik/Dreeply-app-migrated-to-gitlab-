{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport _regeneratorRuntime from \"C:/off-saas/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"C:/off-saas/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\n\nvar _jsxFileName = \"C:\\\\off-saas\\\\lib\\\\newAuth.js\",\n    _s = $RefreshSig$(),\n    _this = this,\n    _s2 = $RefreshSig$();\n\nimport firebase, { auth, db } from '../lib/firebase';\nimport React, { useContext, createContext, useEffect, useState } from 'react';\nimport Cookies from 'js-cookie';\nimport { Router } from 'next/router';\nexport var AuthContext = /*#__PURE__*/createContext(); // Tutaj można umieścić default Value\n\nexport var useAuth = function useAuth() {\n  _s();\n\n  return useContext(AuthContext);\n};\n\n_s(useAuth, \"gDsCjeeItUuvgOWf1v4qoK9RF6k=\");\n\nexport var AuthProvider = function AuthProvider(_ref) {\n  _s2();\n\n  var children = _ref.children;\n\n  var _useState = useState(),\n      currentUser = _useState[0],\n      setCurrentUser = _useState[1];\n\n  var _useState2 = useState(true),\n      loading = _useState2[0],\n      setLoading = _useState2[1];\n\n  var handleUser = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(user) {\n      var formatedUser;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!user) {\n                _context.next = 11;\n                break;\n              }\n\n              Cookies.set('uid', user.uid, true); // console.log('user - ', user);\n              // console.log('user name - ', name);\n\n              _context.next = 4;\n              return formatUser(user);\n\n            case 4:\n              formatedUser = _context.sent;\n              // const decodedToken = await firebase.auth().currentUser.getIdTokenResult();\n              // console.log(decodedToken.claims.stripeRole);\n              db.collection('users').doc(user.uid).set({\n                formatedUser: formatedUser\n              }, {\n                merge: true\n              });\n              setCurrentUser(formatedUser); // Cookies.set('token', user.za, true);\n\n              setLoading(false);\n              return _context.abrupt(\"return\", formatedUser);\n\n            case 11:\n              setCurrentUser(false); // Cookies.remove('token', user.za);\n\n              Cookies.remove('uid');\n              setLoading(false);\n              return _context.abrupt(\"return\", false);\n\n            case 15:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function handleUser(_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var signUp = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(email, password) {\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return auth.createUserWithEmailAndPassword(email, password).then(function (response) {\n                return handleUser(response.user);\n              });\n\n            case 2:\n              return _context2.abrupt(\"return\", _context2.sent);\n\n            case 3:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function signUp(_x2, _x3) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var logIn = function logIn(email, password) {\n    return auth.signInWithEmailAndPassword(email, password);\n  };\n\n  var logOut = function logOut() {\n    return auth.signOut();\n  };\n\n  useEffect(function () {\n    var unsubscribe = auth.onIdTokenChanged(handleUser);\n    return function () {\n      return unsubscribe();\n    };\n  }, []);\n  var value = {\n    currentUser: currentUser,\n    signUp: signUp,\n    logIn: logIn,\n    logOut: logOut\n  };\n\n  var getStripeRole = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n      var decodedToken;\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              _context3.next = 2;\n              return firebase.auth().currentUser.getIdToken(true);\n\n            case 2:\n              _context3.next = 4;\n              return firebase.auth().currentUser.getIdTokenResult();\n\n            case 4:\n              decodedToken = _context3.sent;\n              return _context3.abrupt(\"return\", decodedToken.claims.stripeRole || 'free');\n\n            case 6:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3);\n    }));\n\n    return function getStripeRole() {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  var formatUser = /*#__PURE__*/function () {\n    var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(user) {\n      var token;\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              console.log('OFF - ', user);\n              _context4.next = 3;\n              return user.getIdToken();\n\n            case 3:\n              token = _context4.sent;\n              _context4.t0 = user.uid;\n              _context4.t1 = user.email;\n              _context4.t2 = user.providerData[0].providerId;\n              _context4.next = 9;\n              return getStripeRole();\n\n            case 9:\n              _context4.t3 = _context4.sent;\n              _context4.t4 = token;\n              return _context4.abrupt(\"return\", {\n                uid: _context4.t0,\n                email: _context4.t1,\n                provider: _context4.t2,\n                stripeRole: _context4.t3,\n                token: _context4.t4\n              });\n\n            case 12:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    }));\n\n    return function formatUser(_x4) {\n      return _ref5.apply(this, arguments);\n    };\n  }();\n\n  return /*#__PURE__*/_jsxDEV(AuthContext.Provider, {\n    value: value,\n    children: !loading && children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 90,\n    columnNumber: 10\n  }, _this);\n};\n\n_s2(AuthProvider, \"1cdeWWSmbSz3cOWqWLAt+Ta4DMY=\");\n\n_c = AuthProvider;\n\nvar _c;\n\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"sources":["C:/off-saas/lib/newAuth.js"],"names":["firebase","auth","db","React","useContext","createContext","useEffect","useState","Cookies","Router","AuthContext","useAuth","AuthProvider","children","currentUser","setCurrentUser","loading","setLoading","handleUser","user","set","uid","formatUser","formatedUser","collection","doc","merge","remove","signUp","email","password","createUserWithEmailAndPassword","then","response","logIn","signInWithEmailAndPassword","logOut","signOut","unsubscribe","onIdTokenChanged","value","getStripeRole","getIdToken","getIdTokenResult","decodedToken","claims","stripeRole","console","log","token","providerData","providerId","provider"],"mappings":"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","sourcesContent":["import firebase, { auth, db } from '../lib/firebase';\r\nimport React, { useContext, createContext, useEffect, useState } from 'react';\r\nimport Cookies from 'js-cookie';\r\nimport { Router } from 'next/router';\r\n\r\nexport const AuthContext = createContext(); // Tutaj można umieścić default Value\r\n\r\nexport const useAuth = () => {\r\n  return useContext(AuthContext);\r\n};\r\n\r\nexport const AuthProvider = ({ children }) => {\r\n  const [currentUser, setCurrentUser] = useState();\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const handleUser = async (user) => {\r\n    if (user) {\r\n      Cookies.set('uid', user.uid, true);\r\n      // console.log('user - ', user);\r\n      // console.log('user name - ', name);\r\n      const formatedUser = await formatUser(user);\r\n\r\n      // const decodedToken = await firebase.auth().currentUser.getIdTokenResult();\r\n      // console.log(decodedToken.claims.stripeRole);\r\n\r\n      db.collection('users').doc(user.uid).set({ formatedUser }, { merge: true });\r\n\r\n      setCurrentUser(formatedUser);\r\n      // Cookies.set('token', user.za, true);\r\n\r\n      setLoading(false);\r\n      return formatedUser;\r\n    } else {\r\n      setCurrentUser(false);\r\n      // Cookies.remove('token', user.za);\r\n      Cookies.remove('uid');\r\n\r\n      setLoading(false);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const signUp = async (email, password) => {\r\n    return await auth.createUserWithEmailAndPassword(email, password).then((response) => {\r\n      return handleUser(response.user);\r\n    });\r\n  };\r\n\r\n  const logIn = (email, password) => {\r\n    return auth.signInWithEmailAndPassword(email, password);\r\n  };\r\n\r\n  const logOut = () => {\r\n    return auth.signOut();\r\n  };\r\n\r\n  useEffect(() => {\r\n    const unsubscribe = auth.onIdTokenChanged(handleUser);\r\n\r\n    return () => unsubscribe();\r\n  }, []);\r\n\r\n  const value = {\r\n    currentUser,\r\n    signUp,\r\n    logIn,\r\n    logOut,\r\n  };\r\n\r\n  const getStripeRole = async () => {\r\n    await firebase.auth().currentUser.getIdToken(true);\r\n    const decodedToken = await firebase.auth().currentUser.getIdTokenResult();\r\n    return decodedToken.claims.stripeRole || 'free';\r\n  };\r\n\r\n  const formatUser = async (user) => {\r\n    console.log('OFF - ', user);\r\n    const token = await user.getIdToken();\r\n    return {\r\n      uid: user.uid,\r\n      email: user.email,\r\n      // name,\r\n      // token: user.za, // token JWT, generowany automatycznie przez firebase przy zakładaniu konta\r\n      provider: user.providerData[0].providerId,\r\n      stripeRole: await getStripeRole(),\r\n      token,\r\n    };\r\n  };\r\n\r\n  return <AuthContext.Provider value={value}>{!loading && children}</AuthContext.Provider>;\r\n};\r\n"]},"metadata":{},"sourceType":"module"}